#!/bin/sh

# Attention! File generated by IBGETools, do not modify!

# Create virtual geo references for all the .tif we have:
{%- for item in item_list %}
gdal_translate -of vrt -a_srs '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs' \
    -a_ullr {{ item.west }} {{ item.north }} {{ item.east }} {{ item.south }} \
    "{{ item.name }}.tif" "{{ item.vrt_name }}.vrt"
{%- endfor %}


# Merge of all the geo referenced images into a single .vrt, this creates our mosaic:
gdalbuildvrt -resolution highest -o {{ data.id }}.vrt {{ data.current_path }}/{{ data.id }}_*.vrt


# Create the directory for the TileMill project:
mkdir -p {{ data.current_path }}/project/{{ data.id }}


# Create the CSS style for the TileMill project:
cat << 'EOF' > {{ data.current_path }}/project/{{ data.id }}/style.mss
#{{ data.id }} {
  raster-opacity: 1;
  raster-scaling: bilinear;
}
EOF


# Create the TileMill project using the "new project" defaults + our layer:
cat << 'EOF' > {{ data.current_path }}/project/{{ data.id }}/project.mml
{
  "bounds": [ -180, -85.05112877980659, 180,  85.05112877980659 ],
  "center": [ 0, 0, 2 ],
  "format": "png8",
  "interactivity": false,
  "minzoom": 0,
  "maxzoom": 22,
  "srs": "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over",
  "Stylesheet": [ "style.mss" ],
  "Layer": [
    {
      "geometry": "raster",
      "extent": [ {{ data.west }}, {{ data.south }}, {{ data.east }}, {{ data.north }} ],
      "id": "{{ data.id }}",
      "class": "",
      "Datasource": {
        "file": "{{ data.current_path }}/{{ data.id }}.vrt"
      },
      "srs-name": "WGS84",
      "srs": "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",
      "advanced": {},
      "name": "{{ data.id }}"
    }
  ],
  "scale": 1,
  "metatile": 2,
  "_basemap": "",
  "name": "",
  "description": ""
}
EOF


# Create tiles using the .mbtiles format:
node /usr/share/tilemill/index.js export {{ data.id }} {{ data.id }}.mbtiles --format=mbtiles \
    --metatile=16 --minzoom=5 --maxzoom=14 --files=. \
    --bbox={{ data.west }},{{ data.south }},{{ data.east }},{{ data.north }}


{% if data.config %}
# Upload the map to the cloud:
node /usr/share/tilemill/index.js export {{ data.id }} {{ data.id }}.mbtiles --format=upload \
    --config={{ data.config }}
{% endif %}
